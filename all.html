<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>All Sunscreens ‚Äì Sunscreen DNA</title>

  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="stylesheet" href="styles/global.css">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="page-all">

  <!-- ==========================================
       SITE HEADER
       ========================================== -->
  <header class="site-header">
    <div class="header-inner">

      <img
        src="images/sunscreen-dna-logo-cropped.png"
        alt="Sunscreen DNA"
        class="site-logo"
      >

      <nav class="site-nav">

        <form id="site-search" action="searchresults.html" method="GET" class="search-bar">
          <input type="text" name="q" placeholder="Search sunscreens‚Ä¶" required />
          <button type="submit" aria-label="Search">üîç</button>
        </form>

        <div class="dropdown">
          <button class="dropdown-btn menu-link">Explore Sunscreens</button>
          <div class="dropdown-content">
            <a href="all.html">All Sunscreens</a>
            <a href="brands.html">By Brand</a>
            <a href="types.html">By Filter Type</a>
            <a href="spf.html">By SPF Range</a>
            <a href="finish.html">By Finish</a>
            <a href="filters.html">UV Filter Encyclopedia</a>
          </div>
        </div>

        <a
          href="https://github.com/sunscreenlab/sunscreendna/issues/new?template=sunscreen-submission.yml"
          class="menu-link menu-link-primary"
          target="_blank"
          rel="noopener noreferrer"
        >
          Add a Sunscreen
        </a>

      </nav>

      <button class="nav-toggle" aria-label="Open menu">‚ò∞</button>
    </div>
  </header>

  <!-- ==========================================
       PAGE HEADER
       ========================================== -->
  <section class="section">
    <h1>All Sunscreens</h1>
    <p>
      Browse and filter all sunscreens currently in the Sunscreen DNA database.
      Filter type (mineral, chemical, hybrid) is determined automatically based
      on UV filters used.
    </p>
  </section>

  <!-- ==========================================
       FILTER BAR
       ========================================== -->
  <section class="section">
    <div style="display:flex; gap:32px; flex-wrap:wrap;">

      <!-- Region (unchanged for now) -->
      <div>
        <label for="regionFilter"><strong>Region</strong></label><br>
        <select id="regionFilter">
          <option value="">All</option>
          <option value="US">United States</option>
          <option value="EU">EU</option>
          <option value="Korea">Korea</option>
          <option value="Japan">Japan</option>
          <option value="Australia">Australia</option>
        </select>
      </div>

      <!-- Filter Type (stacked checkboxes) -->
      <div>
        <strong>Filter Type</strong><br>

        <label>
          <input type="checkbox" name="filterType" value="Mineral">
          Mineral
        </label><br>

        <label>
          <input type="checkbox" name="filterType" value="Chemical">
          Chemical
        </label><br>

        <label>
          <input type="checkbox" name="filterType" value="Hybrid">
          Hybrid
        </label>
      </div>

      <div style="align-self:flex-end;">
        <button id="resetFilters">Reset Filters</button>
      </div>

    </div>

    <p id="resultsSummary" style="margin-top:12px; color:var(--color-text-light);"></p>
  </section>

  <!-- ==========================================
       RESULTS TABLE
       ========================================== -->
  <section class="section">
    <div style="overflow-x:auto;">
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="border-bottom:1px solid var(--color-border);">
            <th data-sort="brand">Brand <span class="sort-indicator"></span></th>
            <th data-sort="product">Product <span class="sort-indicator"></span></th>
            <th data-sort="spf">SPF <span class="sort-indicator"></span></th>
            <th data-sort="region">Region <span class="sort-indicator"></span></th>
            <th data-sort="filterType">Filter Type <span class="sort-indicator"></span></th>
          </tr>
        </thead>
        <tbody id="resultsTable"></tbody>
      </table>
    </div>
  </section>

  <!-- ==========================================
       SCRIPTS
       ========================================== -->
  <script src="script.js"></script>

  <script>
    let allSunscreens = [];
    let currentSortColumn = null;
    let currentSortDirection = "asc";

    function getSelectedFilterTypes() {
      return Array.from(
        document.querySelectorAll("input[name='filterType']:checked")
      ).map(cb => cb.value);
    }

    function applyFilters() {
      const region = document.getElementById("regionFilter").value;
      const selectedTypes = getSelectedFilterTypes();

      let filtered = allSunscreens.filter(s => {
        const derivedType = getFilterType(s.filters || []);

        return (
          (!region || s.region === region) &&
          (selectedTypes.length === 0 || selectedTypes.includes(derivedType))
        );
      });

      if (currentSortColumn) {
        filtered = sortData(filtered, currentSortColumn);
      }

      renderTable(filtered);
    }

    function sortData(data, column) {
      const direction = currentSortDirection === "asc" ? 1 : -1;

      return data.slice().sort((a, b) => {
        let valA, valB;

        if (column === "filterType") {
          valA = getFilterType(a.filters || []);
          valB = getFilterType(b.filters || []);
        } else if (column === "product") {
          valA = a.product || a.name || "";
          valB = b.product || b.name || "";
        } else {
          valA = a[column] || "";
          valB = b[column] || "";
        }

        if (typeof valA === "string") valA = valA.toLowerCase();
        if (typeof valB === "string") valB = valB.toLowerCase();

        if (valA < valB) return -1 * direction;
        if (valA > valB) return 1 * direction;
        return 0;
      });
    }

    function renderTable(data) {
      const table = document.getElementById("resultsTable");
      table.innerHTML = "";

      data.forEach(s => {
        const filterType = getFilterType(s.filters || []);
        const row = document.createElement("tr");

        row.innerHTML =
          "<td>" + (s.brand || "") + "</td>" +
          "<td><a href='sunscreen.html?id=" + encodeURIComponent(s.id) + "'>" +
            (s.product || s.name || "") +
          "</a></td>" +
          "<td>" + (s.spf || "") + "</td>" +
          "<td>" + (s.region || "") + "</td>" +
          "<td>" + filterType + "</td>";

        table.appendChild(row);
      });

      document.getElementById("resultsSummary").textContent =
        "Showing " + data.length + " sunscreens";
    }

    document.querySelectorAll("th[data-sort]").forEach(th => {
      th.addEventListener("click", () => {
        const column = th.dataset.sort;

        if (currentSortColumn === column) {
          currentSortDirection = currentSortDirection === "asc" ? "desc" : "asc";
        } else {
          currentSortColumn = column;
          currentSortDirection = "asc";
        }

        document.querySelectorAll("th").forEach(h =>
          h.classList.remove("sorted-asc", "sorted-desc")
        );

        th.classList.add(
          currentSortDirection === "asc" ? "sorted-asc" : "sorted-desc"
        );

        applyFilters();
      });
    });

    document.getElementById("regionFilter").addEventListener("change", applyFilters);
    document.querySelectorAll("input[name='filterType']").forEach(cb =>
      cb.addEventListener("change", applyFilters)
    );

    document.getElementById("resetFilters").addEventListener("click", () => {
      document.getElementById("regionFilter").value = "";
      document
        .querySelectorAll("input[name='filterType']")
        .forEach(cb => cb.checked = false);
      applyFilters();
    });

    loadSunscreens().then(data => {
      allSunscreens = data || [];
      renderTable(allSunscreens);
    });
  </script>

</body>
</html>
